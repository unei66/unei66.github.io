<!DOCTYPE HTML>

    <html lang="zh-Hans">
  
<head>
  <meta charset="utf-8">
  
  <title>Page 2 | Hello World</title>
  <meta name="author" content="hello world">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Hello World"/>

  
    <meta property="og:image" content=""/>
  

  
    <meta http-equiv="Content-Language" content="zh-Hans"/>
  

  <link href="/img/favicon.png" rel="icon">
  
    <link rel="apple-touch-icon" href="/img/apple-icon.png">
    <link rel="apple-touch-icon-precomposed" href="/img/apple-icon.png">
    

  <link rel="alternate" href="/atom.xml" title="Hello World" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
  <style type="text/css">
  /* Tim Pietrusky advanced checkbox hack (Android <= 4.1.2) */
body{ -webkit-animation: bugfix infinite 1s; }
@-webkit-keyframes bugfix { from {padding:0;} to {padding:0;} }

  
  <!-- Chinese readability improvements -->
    article {font-weight: 400;letter-spacing: .01rem;}
    article .entry{line-height:2;}
  

  
    article .post-content-index .entry{max-height: 550px; overflow:hidden;}
  
</style>

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');
 
</script>




  
  
</head>


<body>
  <header id="header" class="inner"><div class="padding">
	<div class="alignleft logo">
	  <h1><a href="/">Hello World</a></h1>
	</div>
	<nav id="main-nav" class="alignright">
		<input type="checkbox" id="toggle" />
		<label for="toggle" class="toggle" data-open="Main Menu" data-close="Close Menu" onclick><i class="fa fa-bars"></i></label>
	  <ul class="menu">
	    
	      <li><a href="/">Home</a></li>
	    
	      <li><a href="/archives">Archives</a></li>
	    
	    
	  </ul>
	</nav>
	<div class="clearfix"></div>
</div>
</header>
  <div id="page-heading-wrap">
  	<div class="inner">
      <div class="padding">
    		
          <h2></h2>
        
      </div>
  	</div>
  </div>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper" class="padding">
  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2018/04/17/hystrix/How-To-Use/">how to use</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2018-04-16T16:00:00.000Z">2018-04-17</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">hello world</a>
                

              </li>
            
            <li>
              <span class="heading-span">With: </span>
              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <h2 id="Contents"><a href="#Contents" class="headerlink" title="Contents"></a>Contents</h2><ol>
<li><a href="#Hello-World">&ldquo;Hello World!&rdquo;</a></li>
<li><a href="#Synchronous-Execution">Synchronous Execution</a></li>
<li><a href="#Asynchronous-Execution">Asynchronous Execution</a></li>
<li><a href="#Reactive-Execution">Reactive Execution</a></li>
<li><a href="#Reactive-Commands">Reactive Commands</a></li>
<li><a href="#Fallback">Fallback</a></li>
<li><a href="#ErrorPropagation">Error Propagation</a></li>
<li><a href="#CommandName">Command Name</a></li>
<li><a href="#CommandGroup">Command Group</a></li>
<li><a href="#CommandThreadPool">Command Thread-Pool</a></li>
<li><a href="#Caching">Request Cache</a></li>
<li><a href="#Collapsing">Request Collapsing</a></li>
<li><a href="#RequestContextSetup">Request Context Setup</a></li>
<li><a href="#Common-Patterns">Common Patterns:</a><ol>
<li><a href="#Common-Patterns-FailFast">Fail Fast</a></li>
<li><a href="#Common-Patterns-FailSilent">Fail Silent</a></li>
<li><a href="#Common-Patterns-FallbackStatic">Fallback: Static</a></li>
<li><a href="#Common-Patterns-FallbackStubbed">Fallback: Stubbed</a></li>
<li><a href="#Common-Patterns-FallbackCacheViaNetwork">Fallback: Cache via Network</a></li>
<li><a href="#Common-Patterns-PrimarySecondaryWithFallback">Primary + Secondary with Fallback</a></li>
<li><a href="#Common-Patterns-Sempahore">Client Doesn&#8217;t Perform Network Access</a></li>
<li><a href="#Common-Patterns-GetSetGet">Get-Set-Get with Request Cache Invalidation</a></li>
</ol>
</li>
<li><a href="#MigratingLibrary">Migrating a Library to Hystrix</a></li>
</ol>
<p><a name="Hello-World"></a></p>
<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World!"></a>Hello World!</h2><p>The following is a basic &ldquo;Hello World&rdquo; implementation of a <a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixCommand.html" target="_blank" rel="noopener"><code>HystrixCommand</code></a>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandHelloWorld</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommandHelloWorld</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>));</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// a real example would do work like a network call here</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello "</span> + name + <span class="string">"!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="../blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandHelloWorld.java">View Source</a></p>
<h4 id="HystrixObservableCommand-Equivalent"><a href="#HystrixObservableCommand-Equivalent" class="headerlink" title="HystrixObservableCommand Equivalent"></a><code>HystrixObservableCommand</code> Equivalent</h4><p>An equivalent Hello World solution that uses a <a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixObservableCommand.html" target="_blank" rel="noopener"><code>HystrixObservableCommand</code></a> instead of a <code>HystrixCommand</code> would involve overriding the <code>construct</code> method as follows:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandHelloWorld</span> <span class="keyword">extends</span> <span class="title">HystrixObservableCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommandHelloWorld</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>));</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Observable&lt;String&gt; <span class="title">construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> String&gt; observer)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!observer.isUnsubscribed()) &#123;</span><br><span class="line">                        <span class="comment">// a real example would do work like a network call here</span></span><br><span class="line">                        observer.onNext(<span class="string">"Hello"</span>);</span><br><span class="line">                        observer.onNext(name + <span class="string">"!"</span>);</span><br><span class="line">                        observer.onCompleted();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    observer.onError(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125; ).subscribeOn(Schedulers.io());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a name="Synchronous-Execution"></a></p>
<h2 id="Synchronous-Execution"><a href="#Synchronous-Execution" class="headerlink" title="Synchronous Execution"></a>Synchronous Execution</h2><p>You can execute a <code>HystrixCommand</code> synchronously with the <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#execute\(\" target="_blank" rel="noopener"><code>execute()</code></a>) method, as in the following example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="keyword">new</span> CommandHelloWorld(<span class="string">"World"</span>).execute();</span><br></pre></td></tr></table></figure>
<p>Execution of this form passes the following tests:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSynchronous</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertEquals(<span class="string">"Hello World!"</span>, <span class="keyword">new</span> CommandHelloWorld(<span class="string">"World"</span>).execute());</span><br><span class="line">    assertEquals(<span class="string">"Hello Bob!"</span>, <span class="keyword">new</span> CommandHelloWorld(<span class="string">"Bob"</span>).execute());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HystrixObservableCommand-Equivalent-1"><a href="#HystrixObservableCommand-Equivalent-1" class="headerlink" title="HystrixObservableCommand Equivalent"></a><code>HystrixObservableCommand</code> Equivalent</h4><p>There is no simple equivalent to <code>execute</code> for a <code>HystrixObservableCommand</code>, but if you know that the <code>Observable</code> produced by such a command must always produce only a single value, you can mimic the behavior of <code>execute</code> by applying <code>.toBlocking().toFuture().get()</code> to the <code>Observable</code>.</p>
<p><a name="Asynchronous-Execution"></a></p>
<h2 id="Asynchronous-Execution"><a href="#Asynchronous-Execution" class="headerlink" title="Asynchronous Execution"></a>Asynchronous Execution</h2><p>You can execute a <code>HystrixCommand</code> asynchronously by using the <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#queue\(\" target="_blank" rel="noopener"><code>queue()</code></a>) method, as in the following example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;String&gt; fs = <span class="keyword">new</span> CommandHelloWorld(<span class="string">"World"</span>).queue();</span><br></pre></td></tr></table></figure>
<p>You can retrieve the result of the command by using the Future:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = fs.get();</span><br></pre></td></tr></table></figure>
<p>The following unit tests demonstrate the behavior:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAsynchronous1</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    assertEquals(<span class="string">"Hello World!"</span>, <span class="keyword">new</span> CommandHelloWorld(<span class="string">"World"</span>).queue().get());</span><br><span class="line">    assertEquals(<span class="string">"Hello Bob!"</span>, <span class="keyword">new</span> CommandHelloWorld(<span class="string">"Bob"</span>).queue().get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAsynchronous2</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    Future&lt;String&gt; fWorld = <span class="keyword">new</span> CommandHelloWorld(<span class="string">"World"</span>).queue();</span><br><span class="line">    Future&lt;String&gt; fBob = <span class="keyword">new</span> CommandHelloWorld(<span class="string">"Bob"</span>).queue();</span><br><span class="line"></span><br><span class="line">    assertEquals(<span class="string">"Hello World!"</span>, fWorld.get());</span><br><span class="line">    assertEquals(<span class="string">"Hello Bob!"</span>, fBob.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The following are equivalent to each other:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="keyword">new</span> CommandHelloWorld(<span class="string">"World"</span>).execute();</span><br><span class="line">String s2 = <span class="keyword">new</span> CommandHelloWorld(<span class="string">"World"</span>).queue().get();</span><br></pre></td></tr></table></figure>
<h4 id="HystrixObservableCommand-Equivalent-2"><a href="#HystrixObservableCommand-Equivalent-2" class="headerlink" title="HystrixObservableCommand Equivalent"></a><code>HystrixObservableCommand</code> Equivalent</h4><p>There is no simple equivalent to <code>queue</code> for a <code>HystrixObservableCommand</code>, but if you know that the <code>Observable</code> produced by such a command must always produce only a single value, you can mimic the behavior of <code>queue</code> by applying the RxJava operators <code>.toBlocking().toFuture()</code> to the <code>Observable</code>.</p>
<p><a name="Reactive-Execution"></a></p>
<h2 id="Reactive-Execution"><a href="#Reactive-Execution" class="headerlink" title="Reactive Execution"></a>Reactive Execution</h2><p>You can also observe the results of a <code>HystrixCommand</code> as an <code>Observable</code> by using one of the following methods:</p>
<ul>
<li><a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#observe\(\" target="_blank" rel="noopener"><code>observe()</code></a>) &mdash; returns a &ldquo;hot&rdquo; Observable that executes the command immediately, though because the Observable is filtered through a <code>ReplaySubject</code> you are not in danger of losing any items that it emits before you have a chance to subscribe</li>
<li><a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#toObservable\(\" target="_blank" rel="noopener"><code>toObservable()</code></a>) &mdash; returns a &ldquo;cold&rdquo; Observable that won&#8217;t execute the command and begin emitting its results until you subscribe to the Observable</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;String&gt; ho = <span class="keyword">new</span> CommandHelloWorld(<span class="string">"World"</span>).observe();</span><br><span class="line"><span class="comment">// or Observable&lt;String&gt; co = new CommandHelloWorld("World").toObservable();</span></span><br></pre></td></tr></table></figure>
<p>You then retrieve the value of the command by subscribing to the Observable:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ho.subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">         <span class="comment">// value emitted here</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>The following unit tests demonstrate the behavior:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testObservable</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    Observable&lt;String&gt; fWorld = <span class="keyword">new</span> CommandHelloWorld(<span class="string">"World"</span>).observe();</span><br><span class="line">    Observable&lt;String&gt; fBob = <span class="keyword">new</span> CommandHelloWorld(<span class="string">"Bob"</span>).observe();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// blocking</span></span><br><span class="line">    assertEquals(<span class="string">"Hello World!"</span>, fWorld.toBlockingObservable().single());</span><br><span class="line">    assertEquals(<span class="string">"Hello Bob!"</span>, fBob.toBlockingObservable().single());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// non-blocking </span></span><br><span class="line">    <span class="comment">// - this is a verbose anonymous inner-class approach and doesn't do assertions</span></span><br><span class="line">    fWorld.subscribe(<span class="keyword">new</span> Observer&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// nothing needed here</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String v)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"onNext: "</span> + v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// non-blocking</span></span><br><span class="line">    <span class="comment">// - also verbose anonymous inner-class</span></span><br><span class="line">    <span class="comment">// - ignore errors and onCompleted signal</span></span><br><span class="line">    fBob.subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String v)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"onNext: "</span> + v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Using Java 8 lambdas/closures is more compact; it would look like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fWorld.subscribe((v) -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"onNext: "</span> + v);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// - or while also including error handling</span></span><br><span class="line"></span><br><span class="line">fWorld.subscribe((v) -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"onNext: "</span> + v);</span><br><span class="line">&#125;, (exception) -&gt; &#123;</span><br><span class="line">    exception.printStackTrace();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>More information about Observable can be found at <a href="http://reactivex.io/documentation/observable.html" target="_blank" rel="noopener">http://reactivex.io/documentation/observable.html</a></p>
<p><a name="Reactive-Commands"></a></p>
<h2 id="Reactive-Commands"><a href="#Reactive-Commands" class="headerlink" title="Reactive Commands"></a>Reactive Commands</h2><p>Rather than converting a <code>HystrixCommand</code> into an <code>Observable</code> using the methods described above, you can also create a <code>HystrixObservableCommand</code> that is a specialized version of <code>HystrixCommand</code> meant to wrap Observables. A <code>HystrixObservableCommand</code> is capable of wrapping Observables that emit multiple items, whereas ordinary <code>HystrixCommands</code>, even when converted into Observables, will never emit more than one item.</p>
<p>In such a case, instead of overriding the <code>run</code> method with your command logic (as you would with an ordinary <code>HystrixCommand</code>), you would override the <code>construct</code> method so that it returns the Observable you intend to wrap.</p>
<p>To obtain an Observable representation of the <code>HystrixObservableCommand</code>, use one of the following two methods:</p>
<ul>
<li><a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixObservableCommand.html#observe\(\" target="_blank" rel="noopener"><code>observe()</code></a>) &mdash; returns a &ldquo;hot&rdquo; Observable that subscribes to the underlying Observable immediately, though because it is filtered through a <code>ReplaySubject</code> you are not in danger of losing any items that it emits before you have a chance to subscribe to the resulting Observable</li>
<li><a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixObservableCommand.html#toObservable\(\" target="_blank" rel="noopener"><code>toObservable()</code></a>) &mdash; returns a &ldquo;cold&rdquo; Observable that won&#8217;t subscribe to the underlying Observable until you subscribe to the resulting Observable</li>
</ul>
<p><a name="Fallback"></a></p>
<h2 id="Fallback"><a href="#Fallback" class="headerlink" title="Fallback"></a>Fallback</h2><p>You can support graceful degradation in a Hystrix command by adding a fallback method that Hystrix will call to obtain a default value or values in case the main command fails.  You will want to implement a fallback for most Hystrix commands that might conceivably fail, with a couple of exceptions:</p>
<ol>
<li>a command that performs a write operation<ul>
<li>If your Hystrix command is designed to do a write operation rather than to return a value (such a command might normally return a <code>void</code> in the case of a <code>HystrixCommand</code> or an empty Observable in the case of a <code>HystrixObservableCommand</code>), there isn&#8217;t much point in implementing a fallback. If the write fails, you probably want the failure to propagate back to the caller.</li>
</ul>
</li>
<li>batch systems/offline compute<ul>
<li>If your Hystrix command is filling up a cache, or generating a report, or doing any sort of offline computation, it&#8217;s usually more appropriate to propagate the error back to the caller who can then retry the command later, rather than to send the caller a silently-degraded response.</li>
</ul>
</li>
</ol>
<p>Whether or not your command has a fallback, all of the usual Hystrix state and circuit-breaker state/metrics are updated to indicate the command failure.</p>
<p>In an ordinary <code>HystrixCommand</code> you implement a fallback by means of a <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#getFallback\(\" target="_blank" rel="noopener"><code>getFallback()</code></a>) implementation. Hystrix will execute this fallback for all types of failure such as <code>run()</code> failure, timeout, thread pool or semaphore rejection, and circuit-breaker short-circuiting. The following example includes such a fallback:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandHelloFailure</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommandHelloFailure</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>));</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"this command always fails"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello Failure "</span> + name + <span class="string">"!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="../blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandHelloFailure.java">View Source</a></p>
<p>This command&#8217;s <code>run()</code> method will fail on every execution. However, the caller will always receive the value returned by the command&#8217;s <code>getFallback()</code> method instead of receiving an exception:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSynchronous</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertEquals(<span class="string">"Hello Failure World!"</span>, <span class="keyword">new</span> CommandHelloFailure(<span class="string">"World"</span>).execute());</span><br><span class="line">    assertEquals(<span class="string">"Hello Failure Bob!"</span>, <span class="keyword">new</span> CommandHelloFailure(<span class="string">"Bob"</span>).execute());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HystrixObservableCommand-Equivalent-3"><a href="#HystrixObservableCommand-Equivalent-3" class="headerlink" title="HystrixObservableCommand Equivalent"></a><code>HystrixObservableCommand</code> Equivalent</h4><p>For a <code>HystrixObservableCommand</code> you instead may override the <code>resumeWithFallback</code> method so that it returns a second <code>Observable</code> that will take over from the primary <code>Observable</code> if it fails. Note that because an <code>Observable</code> may fail after having already emitted one or more items, your fallback should not assume that it will be emitting the only values that the observer will see.</p>
<p>Internally, Hystrix uses the RxJava <a href="http://reactivex.io/documentation/operators/catch.html" target="_blank" rel="noopener"><code>onErrorResumeNext</code></a> operator to seamlessly transition between the primary and fallback <code>Observable</code> in case of an error.</p>
<h4 id="Sequence-Diagram"><a href="#Sequence-Diagram" class="headerlink" title="Sequence Diagram"></a>Sequence Diagram</h4><p>@adrianb11 has kindly provided a <a href="https://design.codelytics.io/hystrix/fallback" target="_blank" rel="noopener">sequence diagram</a> demonstrating how a timeout then fallback works.</p>
<p><a name="ErrorPropagation"></a></p>
<h2 id="Error-Propagation"><a href="#Error-Propagation" class="headerlink" title="Error Propagation"></a>Error Propagation</h2><p>All exceptions thrown from the <code>run()</code> method except for <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/exception/HystrixBadRequestException.html" target="_blank" rel="noopener"><code>HystrixBadRequestException</code></a> count as failures and trigger <code>getFallback()</code> and circuit-breaker logic.</p>
<p>You can wrap the exception that you would like to throw in <code>HystrixBadRequestException</code> and retrieve it via <code>getCause()</code>. The <code>HystrixBadRequestException</code> is intended for use cases such as reporting illegal arguments or non-system failures that should not count against the failure metrics and should not trigger fallback logic.</p>
<h4 id="HystrixObservableCommand-Equivalent-4"><a href="#HystrixObservableCommand-Equivalent-4" class="headerlink" title="HystrixObservableCommand Equivalent"></a><code>HystrixObservableCommand</code> Equivalent</h4><p>In the case of a <code>HystrixObservableCommand</code>, non-recoverable errors are returned via <code>onError</code> notifications from the resulting <code>Observable</code>, and fallbacks are accomplished by falling back to a second Observable that Hystrix obtains through the <code>resumeWithFallback</code> method that you implement.</p>
<h4 id="Execution-Exception-types"><a href="#Execution-Exception-types" class="headerlink" title="Execution Exception types"></a>Execution Exception types</h4><table>
<thead>
<tr>
<th>Failure Type</th>
<th>Exception class</th>
<th>Exception.cause</th>
<th>subject to fallback</th>
</tr>
</thead>
<tbody>
<tr>
<td>FAILURE</td>
<td><code>HystrixRuntimeException</code></td>
<td>underlying exception (user-controlled)</td>
<td>YES</td>
</tr>
<tr>
<td>TIMEOUT</td>
<td><code>HystrixRuntimeException</code></td>
<td><code>j.u.c.TimeoutException</code></td>
<td>YES</td>
</tr>
<tr>
<td>SHORT_CIRCUITED</td>
<td><code>HystrixRuntimeException</code></td>
<td><code>j.l.RuntimeException</code></td>
<td>YES</td>
</tr>
<tr>
<td>THREAD_POOL_REJECTED</td>
<td><code>HystrixRuntimeException</code></td>
<td><code>j.u.c.RejectedExecutionException</code></td>
<td>YES</td>
</tr>
<tr>
<td>SEMAPHORE_REJECTED</td>
<td><code>HystrixRuntimeException</code></td>
<td><code>j.l.RuntimeException</code></td>
<td>YES</td>
</tr>
<tr>
<td>BAD_REQUEST</td>
<td><code>HystrixBadRequestException</code></td>
<td>underlying exception (user-controlled)</td>
<td>NO</td>
</tr>
</tbody>
</table>
<p><a name="CommandName"></a></p>
<h2 id="Command-Name"><a href="#Command-Name" class="headerlink" title="Command Name"></a>Command Name</h2><p>A command name is, by default, derived from the class name:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getClass().getSimpleName();</span><br></pre></td></tr></table></figure>
<p>To explicitly define the name pass it in via the <code>HystrixCommand</code> or <code>HystrixObservableCommand</code> constructor:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CommandHelloWorld</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>))</span><br><span class="line">            .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"HelloWorld"</span>)));</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To save a Setter allocation per command allocation, you may also cache the Setter like so:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Setter cachedSetter = </span><br><span class="line">    Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>))</span><br><span class="line">        .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"HelloWorld"</span>));    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CommandHelloWorld</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(cachedSetter);</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixCommandKey.html" target="_blank" rel="noopener"><code>HystrixCommandKey</code></a> is an interface and can be implemented as an enum or regular class, but it also has the helper <a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixCommandKey.Factory.html" target="_blank" rel="noopener"><code>Factory</code></a> class to construct and intern instances such as:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandKey.Factory.asKey(<span class="string">"HelloWorld"</span>)</span><br></pre></td></tr></table></figure>
<p><a name="CommandGroup"></a></p>
<h2 id="Command-Group"><a href="#Command-Group" class="headerlink" title="Command Group"></a>Command Group</h2><p>Hystrix uses the command group key to group together commands such as for reporting, alerting, dashboards, or team/library ownership.</p>
<p>By default Hystrix uses this to define the command thread-pool unless a separate one is defined.</p>
<p><a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixCommandGroupKey.html" target="_blank" rel="noopener"><code>HystrixCommandGroupKey</code></a> is an interface and can be implemented as an enum or regular class, but it also has the helper <a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixCommandGroupKey.Factory.html" target="_blank" rel="noopener"><code>Factory</code></a> class to construct and intern instances such as:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>)</span><br></pre></td></tr></table></figure>
<p><a name="CommandThreadPool"></a></p>
<h2 id="Command-Thread-Pool"><a href="#Command-Thread-Pool" class="headerlink" title="Command Thread-Pool"></a>Command Thread-Pool</h2><p>The thread-pool key represents a <a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixThreadPool.html" target="_blank" rel="noopener"><code>HystrixThreadPool</code></a> for monitoring, metrics publishing, caching, and other such uses. A <code>HystrixCommand</code> is associated with a single <code>HystrixThreadPool</code> as retrieved by the <a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixThreadPoolKey.html" target="_blank" rel="noopener"><code>HystrixThreadPoolKey</code></a> injected into it, or it defaults to one created using the <code>HystrixCommandGroupKey</code> it is created with.</p>
<p>To explicitly define the name pass it in via the <code>HystrixCommand</code> or <code>HystrixObservableCommand</code> constructor:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CommandHelloWorld</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>))</span><br><span class="line">            .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"HelloWorld"</span>))</span><br><span class="line">            .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(<span class="string">"HelloWorldPool"</span>)));</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixThreadPoolKey.html" target="_blank" rel="noopener"><code>HystrixThreadPoolKey</code></a> is an interface and can be implemented as an enum or regular class, but it also has the helper <a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixThreadPoolKey.Factory.html" target="_blank" rel="noopener"><code>Factory</code></a> class to construct and intern instances such as:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixThreadPoolKey.Factory.asKey(<span class="string">"HelloWorldPool"</span>)</span><br></pre></td></tr></table></figure>
<p>The reason why you might use <code>HystrixThreadPoolKey</code> instead of just a different <code>HystrixCommandGroupKey</code> is that multiple commands may belong to the same &ldquo;group&rdquo; of ownership or logical functionality, but certain commands may need to be isolated from each other.</p>
<p>Here is a simple example:</p>
<ul>
<li>two commands used to access Video metadata</li>
<li>group name is &ldquo;VideoMetadata&rdquo;</li>
<li>command A goes against resource #1</li>
<li>command B goes against resource #2</li>
</ul>
<p>If command A becomes latent and saturates its thread-pool it should not prevent command B from executing requests since they each hit different back-end resources.</p>
<p>Thus, we logically want these commands grouped together but want them isolated differently and would use <code>HystrixThreadPoolKey</code> to give each of them a different thread-pool.</p>
<p><a name="Caching"></a></p>
<h2 id="Request-Cache"><a href="#Request-Cache" class="headerlink" title="Request Cache"></a>Request Cache</h2><p>You enable request caching by implementing the <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#getCacheKey\(\" target="_blank" rel="noopener"><code>getCacheKey()</code></a>) method on a <code>HystrixCommand</code> or <code>HystrixObservableCommand</code> object as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandUsingRequestCache</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">Boolean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">CommandUsingRequestCache</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>));</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Boolean <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value == <span class="number">0</span> || value % <span class="number">2</span> == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getCacheKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="../blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandUsingRequestCache.java">View Source</a></p>
<p>Since this depends on request context we must initialize the <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/strategy/concurrency/HystrixRequestContext.html" target="_blank" rel="noopener"><code>HystrixRequestContext</code></a>.</p>
<p>In a simple unit test you could do this as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWithoutCacheHits</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HystrixRequestContext context = HystrixRequestContext.initializeContext();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        assertTrue(<span class="keyword">new</span> CommandUsingRequestCache(<span class="number">2</span>).execute());</span><br><span class="line">        assertFalse(<span class="keyword">new</span> CommandUsingRequestCache(<span class="number">1</span>).execute());</span><br><span class="line">        assertTrue(<span class="keyword">new</span> CommandUsingRequestCache(<span class="number">0</span>).execute());</span><br><span class="line">        assertTrue(<span class="keyword">new</span> CommandUsingRequestCache(<span class="number">58672</span>).execute());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        context.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Typically this context will be initialized and shut down via a <code>ServletFilter</code> that wraps a user request or some other lifecycle hook.</p>
<p>The following is an example that shows how commands retrieve their values from the cache (and how you can query an object to know whether its value came from the cache) within a request context:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWithCacheHits</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HystrixRequestContext context = HystrixRequestContext.initializeContext();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        CommandUsingRequestCache command2a = <span class="keyword">new</span> CommandUsingRequestCache(<span class="number">2</span>);</span><br><span class="line">        CommandUsingRequestCache command2b = <span class="keyword">new</span> CommandUsingRequestCache(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        assertTrue(command2a.execute());</span><br><span class="line">        <span class="comment">// this is the first time we've executed this command with</span></span><br><span class="line">        <span class="comment">// the value of "2" so it should not be from cache</span></span><br><span class="line">        assertFalse(command2a.isResponseFromCache());</span><br><span class="line"></span><br><span class="line">        assertTrue(command2b.execute());</span><br><span class="line">        <span class="comment">// this is the second time we've executed this command with</span></span><br><span class="line">        <span class="comment">// the same value so it should return from cache</span></span><br><span class="line">        assertTrue(command2b.isResponseFromCache());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        context.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start a new request context</span></span><br><span class="line">    context = HystrixRequestContext.initializeContext();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        CommandUsingRequestCache command3b = <span class="keyword">new</span> CommandUsingRequestCache(<span class="number">2</span>);</span><br><span class="line">        assertTrue(command3b.execute());</span><br><span class="line">        <span class="comment">// this is a new request context so this </span></span><br><span class="line">        <span class="comment">// should not come from cache</span></span><br><span class="line">        assertFalse(command3b.isResponseFromCache());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        context.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="Collapsing"></a></p>
<h2 id="Request-Collapsing"><a href="#Request-Collapsing" class="headerlink" title="Request Collapsing"></a>Request Collapsing</h2><p>Request collapsing enables multiple requests to be batched into a single <code>HystrixCommand</code> instance execution.</p>
<p>A collapser can use the batch size and the elapsed time since the creation of the batch as triggers for executing a batch.</p>
<p>There are 2 styles of request-collapsing supported by Hystrix: request-scoped and globally-scoped.  This is configured at collapser construction, and defaulted to request-scoped.  </p>
<p>A request-scoped collapser collects a batch per <code>HystrixRequestContext</code>, while a globally-scoped collapser collects a batch across multiple <code>HystrixRequestContext</code>s.  As a result, if your downstream dependencies cannot handle multiple <code>HystrixRequestContext</code>s in a single command invocation, request-scoped collapsing is the proper choice.  </p>
<p>At Netflix, we exclusively use request-scoped collapsers because all current systems have been built on the assumption that a single <code>HystrixRequestContext</code> will be used in each command.  Since the batches are per-request only, collapsing is effective when commands occur in parallel with different arguments in the same request.</p>
<p>Following is a simple example of how to implement a request-scoped <a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixCollapser.html" target="_blank" rel="noopener"><code>HystrixCollapser</code></a>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandCollapserGetValueForKey</span> <span class="keyword">extends</span> <span class="title">HystrixCollapser</span>&lt;<span class="title">List</span>&lt;<span class="title">String</span>&gt;, <span class="title">String</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommandCollapserGetValueForKey</span><span class="params">(Integer key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getRequestArgument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> HystrixCommand&lt;List&lt;String&gt;&gt; createCommand(<span class="keyword">final</span> Collection&lt;CollapsedRequest&lt;String, Integer&gt;&gt; requests) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BatchCommand(requests);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">mapResponseToRequests</span><span class="params">(List&lt;String&gt; batchResponse, Collection&lt;CollapsedRequest&lt;String, Integer&gt;&gt; requests)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (CollapsedRequest&lt;String, Integer&gt; request : requests) &#123;</span><br><span class="line">            request.setResponse(batchResponse.get(count++));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">List</span>&lt;<span class="title">String</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;CollapsedRequest&lt;String, Integer&gt;&gt; requests;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">BatchCommand</span><span class="params">(Collection&lt;CollapsedRequest&lt;String, Integer&gt;&gt; requests)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>))</span><br><span class="line">                    .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"GetValueForKey"</span>)));</span><br><span class="line">            <span class="keyword">this</span>.requests = requests;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ArrayList&lt;String&gt; response = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">            <span class="keyword">for</span> (CollapsedRequest&lt;String, Integer&gt; request : requests) &#123;</span><br><span class="line">                <span class="comment">// artificial response for each argument received in the batch</span></span><br><span class="line">                response.add(<span class="string">"ValueForKey: "</span> + request.getArgument());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="../blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandCollapserGetValueForKey.java">View Source</a></p>
<p>The following unit test shows how to use a collapser to automatically batch four executions of <code>CommandCollapserGetValueForKey</code> into a single <code>HystrixCommand</code> execution:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCollapser</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    HystrixRequestContext context = HystrixRequestContext.initializeContext();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Future&lt;String&gt; f1 = <span class="keyword">new</span> CommandCollapserGetValueForKey(<span class="number">1</span>).queue();</span><br><span class="line">        Future&lt;String&gt; f2 = <span class="keyword">new</span> CommandCollapserGetValueForKey(<span class="number">2</span>).queue();</span><br><span class="line">        Future&lt;String&gt; f3 = <span class="keyword">new</span> CommandCollapserGetValueForKey(<span class="number">3</span>).queue();</span><br><span class="line">        Future&lt;String&gt; f4 = <span class="keyword">new</span> CommandCollapserGetValueForKey(<span class="number">4</span>).queue();</span><br><span class="line"></span><br><span class="line">        assertEquals(<span class="string">"ValueForKey: 1"</span>, f1.get());</span><br><span class="line">        assertEquals(<span class="string">"ValueForKey: 2"</span>, f2.get());</span><br><span class="line">        assertEquals(<span class="string">"ValueForKey: 3"</span>, f3.get());</span><br><span class="line">        assertEquals(<span class="string">"ValueForKey: 4"</span>, f4.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// assert that the batch command 'GetValueForKey' was in fact</span></span><br><span class="line">        <span class="comment">// executed and that it executed only once</span></span><br><span class="line">        assertEquals(<span class="number">1</span>, HystrixRequestLog.getCurrentRequest().getExecutedCommands().size());</span><br><span class="line">        HystrixCommand&lt;?&gt; command = HystrixRequestLog.getCurrentRequest().getExecutedCommands().toArray(<span class="keyword">new</span> HystrixCommand&lt;?&gt;[<span class="number">1</span>])[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// assert the command is the one we're expecting</span></span><br><span class="line">        assertEquals(<span class="string">"GetValueForKey"</span>, command.getCommandKey().name());</span><br><span class="line">        <span class="comment">// confirm that it was a COLLAPSED command execution</span></span><br><span class="line">        assertTrue(command.getExecutionEvents().contains(HystrixEventType.COLLAPSED));</span><br><span class="line">        <span class="comment">// and that it was successful</span></span><br><span class="line">        assertTrue(command.getExecutionEvents().contains(HystrixEventType.SUCCESS));</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        context.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="RequestContextSetup"></a></p>
<h2 id="Request-Context-Setup"><a href="#Request-Context-Setup" class="headerlink" title="Request Context Setup"></a>Request Context Setup</h2><p>To use request-scoped features (request caching, request collapsing, request log) you must manage the <a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/strategy/concurrency/HystrixRequestContext.html" target="_blank" rel="noopener"><code>HystrixRequestContext</code></a> lifecycle (or implement an alternative <a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/strategy/concurrency/HystrixConcurrencyStrategy.html" target="_blank" rel="noopener"><code>HystrixConcurrencyStrategy</code></a>).</p>
<p>This means that you must execute the following before a request:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixRequestContext context = HystrixRequestContext.initializeContext();</span><br></pre></td></tr></table></figure>
<p>and then this at the end of the request:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.shutdown();</span><br></pre></td></tr></table></figure>
<p>In a standard Java web application, you can use a Servlet Filter to initialize this lifecycle by implementing a filter similar to this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixRequestContextServletFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> </span></span><br><span class="line"><span class="function">     <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HystrixRequestContext context = HystrixRequestContext.initializeContext();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            context.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You could enable the filter for all incoming traffic by adding a section to the <code>web.xml</code> as follows:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> &lt;filter&gt;</span><br><span class="line">   &lt;display-name&gt;HystrixRequestContextServletFilter&lt;/display-name&gt;</span><br><span class="line">   &lt;filter-name&gt;HystrixRequestContextServletFilter&lt;/filter-name&gt;</span><br><span class="line">   &lt;filter-class&gt;com.netflix.hystrix.contrib.requestservlet.HystrixRequestContextServletFilter&lt;/filter-class&gt;</span><br><span class="line"> &lt;/filter&gt;</span><br><span class="line"> &lt;filter-mapping&gt;</span><br><span class="line">   &lt;filter-name&gt;HystrixRequestContextServletFilter&lt;/filter-name&gt;</span><br><span class="line">   &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</span><br><span class="line">&lt;/filter-mapping&gt;</span><br></pre></td></tr></table></figure>
<p><a name="Common-Patterns"></a></p>
<h2 id="Common-Patterns"><a href="#Common-Patterns" class="headerlink" title="Common Patterns"></a>Common Patterns</h2><p>In the following sections are common uses and patterns of use for <code>HystrixCommand</code> and <code>HystrixObservableCommand</code>.</p>
<p><a name="Common-Patterns-FailFast"></a></p>
<h3 id="Fail-Fast"><a href="#Fail-Fast" class="headerlink" title="Fail Fast"></a>Fail Fast</h3><p>The most basic execution is one that does a single thing and has no fallback behavior. It will throw an exception if any type of failure occurs.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandThatFailsFast</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> throwException;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommandThatFailsFast</span><span class="params">(<span class="keyword">boolean</span> throwException)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>));</span><br><span class="line">        <span class="keyword">this</span>.throwException = throwException;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (throwException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"failure from CommandThatFailsFast"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><a href="../blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandThatFailsFast.java">View Source</a></p>
<p>These unit tests show how it behaves:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertEquals(<span class="string">"success"</span>, <span class="keyword">new</span> CommandThatFailsFast(<span class="keyword">false</span>).execute());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFailure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> CommandThatFailsFast(<span class="keyword">true</span>).execute();</span><br><span class="line">        fail(<span class="string">"we should have thrown an exception"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (HystrixRuntimeException e) &#123;</span><br><span class="line">        assertEquals(<span class="string">"failure from CommandThatFailsFast"</span>, e.getCause().getMessage());</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HystrixObservableCommand-Equivalent-5"><a href="#HystrixObservableCommand-Equivalent-5" class="headerlink" title="HystrixObservableCommand Equivalent"></a><code>HystrixObservableCommand</code> Equivalent</h4><p>The equivalent Fail-Fast solution for a <code>HystrixObservableCommand</code> would involve overriding the <code>resumeWithFallback</code> method as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Observable&lt;String&gt; <span class="title">resumeWithFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (throwException) &#123;</span><br><span class="line">        <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> Throwable(<span class="string">"failure from CommandThatFailsFast"</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Observable.just(<span class="string">"success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="Common-Patterns-FailSilent"></a></p>
<h3 id="Fail-Silent"><a href="#Fail-Silent" class="headerlink" title="Fail Silent"></a>Fail Silent</h3><p>Failing silently is the equivalent of returning an empty response or removing functionality. It can be done by returning <code>null</code>, an empty Map, empty List, or other such responses.</p>
<p>You do this by implementing a <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#getFallback\(\" target="_blank" rel="noopener"><code>getFallback()</code></a>) method on the <code>HystrixCommand</code> instance:</p>
<p>[[images/fallback-640.png]]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandThatFailsSilently</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> throwException;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommandThatFailsSilently</span><span class="params">(<span class="keyword">boolean</span> throwException)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>));</span><br><span class="line">        <span class="keyword">this</span>.throwException = throwException;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (throwException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"failure from CommandThatFailsFast"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="../blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandThatFailsSilently.java">View Source</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertEquals(<span class="string">"success"</span>, <span class="keyword">new</span> CommandThatFailsSilently(<span class="keyword">false</span>).execute());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFailure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        assertEquals(<span class="keyword">null</span>, <span class="keyword">new</span> CommandThatFailsSilently(<span class="keyword">true</span>).execute());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (HystrixRuntimeException e) &#123;</span><br><span class="line">        fail(<span class="string">"we should not get an exception as we fail silently with a fallback"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Another implementation that returns an empty list would look like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HystrixObservableCommand-Equivalent-6"><a href="#HystrixObservableCommand-Equivalent-6" class="headerlink" title="HystrixObservableCommand Equivalent"></a><code>HystrixObservableCommand</code> Equivalent</h4><p>The equivalent Fail-Silently solution for a <code>HystrixObservableCommand</code> would involve overriding the <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixObservableCommand.html#resumeWithFallback\(\" target="_blank" rel="noopener"><code>resumeWithFallback()</code></a>) method as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Observable&lt;String&gt; <span class="title">resumeWithFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.empty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="Common-Patterns-FallbackStatic"></a></p>
<h3 id="Fallback-Static"><a href="#Fallback-Static" class="headerlink" title="Fallback: Static"></a>Fallback: Static</h3><p>Fallbacks can return default values statically embedded in code. This doesn&#8217;t cause the feature or service to be removed in the way that &ldquo;fail silent&rdquo; often does, but instead causes default behavior to occur.</p>
<p>For example, if a command returns a true/false based on user credentials but the command execution fails, it can default to true:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Boolean <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HystrixObservableCommand-Equivalent-7"><a href="#HystrixObservableCommand-Equivalent-7" class="headerlink" title="HystrixObservableCommand Equivalent"></a><code>HystrixObservableCommand</code> Equivalent</h4><p>The equivalent Static solution for a <code>HystrixObservableCommand</code> would involve overriding the <code>resumeWithFallback</code> method as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Observable&lt;Boolean&gt; <span class="title">resumeWithFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.just( <span class="keyword">true</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="Common-Patterns-FallbackStubbed"></a></p>
<h3 id="Fallback-Stubbed"><a href="#Fallback-Stubbed" class="headerlink" title="Fallback: Stubbed"></a>Fallback: Stubbed</h3><p>You typically use a stubbed fallback when your command returns a compound object containing multiple fields, some of which can be determined from other request state while other fields are set to default values.</p>
<p>Examples of places where you might find state appropriate to use in these stubbed values are:</p>
<ul>
<li>cookies</li>
<li>request arguments and headers</li>
<li>responses from previous service requests prior to the current one failing</li>
</ul>
<p>Your fallback can retrieve stubbed values statically from the request scope, but typically it is recommended that they be injected at command instantiation time for use if they are needed such as this following example demonstrates in the way it treats the <code>countryCodeFromGeoLookup</code> field:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandWithStubbedFallback</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">UserAccount</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> customerId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String countryCodeFromGeoLookup;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> customerId</span></span><br><span class="line"><span class="comment">     *            The customerID to retrieve UserAccount for</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> countryCodeFromGeoLookup</span></span><br><span class="line"><span class="comment">     *            The default country code from the HTTP request geo code lookup used for fallback.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">CommandWithStubbedFallback</span><span class="params">(<span class="keyword">int</span> customerId, String countryCodeFromGeoLookup)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>));</span><br><span class="line">        <span class="keyword">this</span>.customerId = customerId;</span><br><span class="line">        <span class="keyword">this</span>.countryCodeFromGeoLookup = countryCodeFromGeoLookup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> UserAccount <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// fetch UserAccount from remote service</span></span><br><span class="line">        <span class="comment">//        return UserAccountClient.getAccount(customerId);</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"forcing failure for example"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> UserAccount <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Return stubbed fallback with some static defaults, placeholders,</span></span><br><span class="line"><span class="comment">         * and an injected value 'countryCodeFromGeoLookup' that we'll use</span></span><br><span class="line"><span class="comment">         * instead of what we would have retrieved from the remote service.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserAccount(customerId, <span class="string">"Unknown Name"</span>,</span><br><span class="line">                countryCodeFromGeoLookup, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAccount</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> customerId;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String countryCode;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isFeatureXPermitted;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isFeatureYPermitted;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isFeatureZPermitted;</span><br><span class="line"></span><br><span class="line">        UserAccount(<span class="keyword">int</span> customerId, String name, String countryCode,</span><br><span class="line">                <span class="keyword">boolean</span> isFeatureXPermitted,</span><br><span class="line">                <span class="keyword">boolean</span> isFeatureYPermitted,</span><br><span class="line">                <span class="keyword">boolean</span> isFeatureZPermitted) &#123;</span><br><span class="line">            <span class="keyword">this</span>.customerId = customerId;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            <span class="keyword">this</span>.countryCode = countryCode;</span><br><span class="line">            <span class="keyword">this</span>.isFeatureXPermitted = isFeatureXPermitted;</span><br><span class="line">            <span class="keyword">this</span>.isFeatureYPermitted = isFeatureYPermitted;</span><br><span class="line">            <span class="keyword">this</span>.isFeatureZPermitted = isFeatureZPermitted;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="../blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandWithStubbedFallback.java">View Source</a></p>
<p>The following unit test demonstrates its behavior:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CommandWithStubbedFallback command = <span class="keyword">new</span> CommandWithStubbedFallback(<span class="number">1234</span>, <span class="string">"ca"</span>);</span><br><span class="line">    UserAccount account = command.execute();</span><br><span class="line">    assertTrue(command.isFailedExecution());</span><br><span class="line">    assertTrue(command.isResponseFromFallback());</span><br><span class="line">    assertEquals(<span class="number">1234</span>, account.customerId);</span><br><span class="line">    assertEquals(<span class="string">"ca"</span>, account.countryCode);</span><br><span class="line">    assertEquals(<span class="keyword">true</span>, account.isFeatureXPermitted);</span><br><span class="line">    assertEquals(<span class="keyword">true</span>, account.isFeatureYPermitted);</span><br><span class="line">    assertEquals(<span class="keyword">false</span>, account.isFeatureZPermitted);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HystrixObservableCommand-Equivalent-8"><a href="#HystrixObservableCommand-Equivalent-8" class="headerlink" title="HystrixObservableCommand Equivalent"></a><code>HystrixObservableCommand</code> Equivalent</h4><p>The equivalent Stubbed solution for a <code>HystrixObservableCommand</code> would involve overriding the <code>resumeWithFallback</code> method to return an <code>Observable</code> that emits the stub responses. A version equivalent to the previous example would look like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Observable&lt;Boolean&gt; <span class="title">resumeWithFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.just( <span class="keyword">new</span> UserAccount(customerId, <span class="string">"Unknown Name"</span>,</span><br><span class="line">                                            countryCodeFromGeoLookup, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>But if you are expecting to emit multiple items from your <code>Observable</code>, you may be more interested in generating stubs for only those items that the original <code>Observable</code> had not yet emitted before it failed. Here is a simple example to show how you might accomplish this &mdash; it keeps track of the last item emitted from the main <code>Observable</code> so that the fallback knows where to pick up to continue the sequence:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Observable&lt;Integer&gt; <span class="title">construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">            .concatWith(Observable.&lt;Integer&gt; error(<span class="keyword">new</span> RuntimeException(<span class="string">"forced error"</span>)))</span><br><span class="line">            .doOnNext(<span class="keyword">new</span> Action1&lt;Integer&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Integer t1)</span> </span>&#123;</span><br><span class="line">                    lastSeen = t1;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;)</span><br><span class="line">            .subscribeOn(Schedulers.computation());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Observable&lt;Integer&gt; <span class="title">resumeWithFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (lastSeen &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Observable.range(lastSeen + <span class="number">1</span>, <span class="number">4</span> - lastSeen);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Observable.empty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="Common-Patterns-FallbackCacheViaNetwork"></a></p>
<h3 id="Fallback-Cache-via-Network"><a href="#Fallback-Cache-via-Network" class="headerlink" title="Fallback: Cache via Network"></a>Fallback: Cache via Network</h3><p>Sometimes if a back-end service fails, a stale version of data can be retrieved from a cache service such as memcached.</p>
<p>Since the fallback will go over the network it is another possible point of failure and so it also needs to be wrapped by a <code>HystrixCommand</code> or <code>HystrixObservableCommand</code>.</p>
<p>[[images/fallback-via-command-640.png]]</p>
<p>It is important to execute the fallback command on a separate thread-pool, otherwise if the main command were to become latent and fill the thread-pool, this would prevent the fallback from running if the two commands share the same pool.</p>
<p>The following code shows how <code>CommandWithFallbackViaNetwork</code> executes <code>FallbackViaNetwork</code> in its <code>getFallback()</code> method.</p>
<p>Note how if the fallback fails, it <em>also</em> has a fallback which does the &ldquo;fail silent&rdquo; approach of returning <code>null</code>.</p>
<p>To configure the <code>FallbackViaNetwork</code> command to run on a different threadpool than the default <code>RemoteServiceX</code> derived from the <a href="http://netflix.github.io/Hystrix/javadoc/index.html?com/netflix/hystrix/HystrixCommandGroupKey.html" target="_blank" rel="noopener"><code>HystrixCommandGroupKey</code></a>, it injects <code>HystrixThreadPoolKey.Factory.asKey(&quot;RemoteServiceXFallback&quot;)</code> into the constructor.</p>
<p>This means <code>CommandWithFallbackViaNetwork</code> will run on a thread-pool named <code>RemoteServiceX</code> and <code>FallbackViaNetwork</code> will run on a thread-pool named <code>RemoteServiceXFallback</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandWithFallbackViaNetwork</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">CommandWithFallbackViaNetwork</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"RemoteServiceX"</span>))</span><br><span class="line">                .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"GetValueCommand"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//        RemoteServiceXClient.getValue(id);</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"force failure for example"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FallbackViaNetwork(id).execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FallbackViaNetwork</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FallbackViaNetwork</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"RemoteServiceX"</span>))</span><br><span class="line">                    .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"GetValueFallbackCommand"</span>))</span><br><span class="line">                    <span class="comment">// use a different threadpool for the fallback command</span></span><br><span class="line">                    <span class="comment">// so saturating the RemoteServiceX pool won't prevent</span></span><br><span class="line">                    <span class="comment">// fallbacks from executing</span></span><br><span class="line">                    .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(<span class="string">"RemoteServiceXFallback"</span>)));</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            MemCacheClient.getValue(id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// the fallback also failed</span></span><br><span class="line">            <span class="comment">// so this fallback-of-a-fallback will </span></span><br><span class="line">            <span class="comment">// fail silently and return null</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="../blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandWithFallbackViaNetwork.java">View Source</a></p>
<p><a name="Common-Patterns-PrimarySecondaryWithFallback"></a></p>
<h3 id="Primary-Secondary-with-Fallback"><a href="#Primary-Secondary-with-Fallback" class="headerlink" title="Primary + Secondary with Fallback"></a>Primary + Secondary with Fallback</h3><p>Some systems have dual-mode behavior &mdash; primary and secondary, or primary and failover.</p>
<p>Sometimes the secondary or failover is considered a failure state and it is intended only for fallback; in those scenarios it would fit in the same pattern as &ldquo;Cache via Network&rdquo; described above.</p>
<p>However, if flipping to the secondary system is common, such as a normal part of rolling out new code (sometimes this is part of how stateful systems handle code pushes) then every time the secondary system is used the primary will be in a failure state, tripping circuit breakers and firing alerts.</p>
<p>This is not the desired behavior, if for no other reason than to avoid the &ldquo;cry wolf&rdquo; fatigue that will cause alerts to be ignored when a real issue is occurring.</p>
<p>So in such a case the strategy is instead to treat the switching between primary and secondary as normal, healthy patterns and put a fa&ccedil;ade in front of them.</p>
<p>[[images/primary-secondary-example-640.png]]</p>
<p>The primary and secondary <code>HystrixCommand</code> implementations are thread-isolated since they are doing network traffic and business logic. They may each have very different performance characteristics (often the secondary system is a static cache) so another benefit of separate commands for each is that they can be individually tuned.</p>
<p>You do not expose these two commands publicly but you instead hide them behind another <code>HystrixCommand</code> that is semaphore-isolated and that implements the conditional logic as to whether to invoke the primary or secondary command. If both primary and secondary fail then control switches to the fallback of the fa&ccedil;ade command itself.</p>
<p>The fa&ccedil;ade <code>HystrixCommand</code> can use semaphore-isolation since all of the work it is doing is going through two other <code>HystrixCommand</code>s that are already thread-isolated. It is unnecessary to have yet another layer of threading as long as the <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#run\(\" target="_blank" rel="noopener"><code>run()</code></a>) method of the fa&ccedil;ade is not doing any other network calls, retry logic, or other &ldquo;error prone&rdquo; things.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandFacadeWithPrimarySecondary</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DynamicBooleanProperty usePrimary = DynamicPropertyFactory.getInstance().getBooleanProperty(<span class="string">"primarySecondary.usePrimary"</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommandFacadeWithPrimarySecondary</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Setter</span><br><span class="line">                .withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"SystemX"</span>))</span><br><span class="line">                .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"PrimarySecondaryCommand"</span>))</span><br><span class="line">                .andCommandPropertiesDefaults(</span><br><span class="line">                        <span class="comment">// we want to default to semaphore-isolation since this wraps</span></span><br><span class="line">                        <span class="comment">// 2 others commands that are already thread isolated</span></span><br><span class="line">                        HystrixCommandProperties.Setter()</span><br><span class="line">                                .withExecutionIsolationStrategy(ExecutionIsolationStrategy.SEMAPHORE)));</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (usePrimary.get()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PrimaryCommand(id).execute();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SecondaryCommand(id).execute();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"static-fallback-"</span> + id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getCacheKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PrimaryCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">PrimaryCommand</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(Setter</span><br><span class="line">                    .withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"SystemX"</span>))</span><br><span class="line">                    .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"PrimaryCommand"</span>))</span><br><span class="line">                    .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(<span class="string">"PrimaryCommand"</span>))</span><br><span class="line">                    .andCommandPropertiesDefaults(</span><br><span class="line">                            <span class="comment">// we default to a 600ms timeout for primary</span></span><br><span class="line">                            HystrixCommandProperties.Setter().withExecutionTimeoutInMilliseconds(<span class="number">600</span>)));</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// perform expensive 'primary' service call</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"responseFromPrimary-"</span> + id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondaryCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">SecondaryCommand</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(Setter</span><br><span class="line">                    .withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"SystemX"</span>))</span><br><span class="line">                    .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"SecondaryCommand"</span>))</span><br><span class="line">                    .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(<span class="string">"SecondaryCommand"</span>))</span><br><span class="line">                    .andCommandPropertiesDefaults(</span><br><span class="line">                            <span class="comment">// we default to a 100ms timeout for secondary</span></span><br><span class="line">                            HystrixCommandProperties.Setter().withExecutionTimeoutInMilliseconds(<span class="number">100</span>)));</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// perform fast 'secondary' service call</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"responseFromSecondary-"</span> + id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UnitTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Test</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPrimary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            HystrixRequestContext context = HystrixRequestContext.initializeContext();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ConfigurationManager.getConfigInstance().setProperty(<span class="string">"primarySecondary.usePrimary"</span>, <span class="keyword">true</span>);</span><br><span class="line">                assertEquals(<span class="string">"responseFromPrimary-20"</span>, <span class="keyword">new</span> CommandFacadeWithPrimarySecondary(<span class="number">20</span>).execute());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                context.shutdown();</span><br><span class="line">                ConfigurationManager.getConfigInstance().clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Test</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSecondary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            HystrixRequestContext context = HystrixRequestContext.initializeContext();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ConfigurationManager.getConfigInstance().setProperty(<span class="string">"primarySecondary.usePrimary"</span>, <span class="keyword">false</span>);</span><br><span class="line">                assertEquals(<span class="string">"responseFromSecondary-20"</span>, <span class="keyword">new</span> CommandFacadeWithPrimarySecondary(<span class="number">20</span>).execute());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                context.shutdown();</span><br><span class="line">                ConfigurationManager.getConfigInstance().clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="../blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandFacadeWithPrimarySecondary.java">View Source</a></p>
<p><a name="Common-Patterns-Semaphore"></a></p>
<h3 id="Client-Doesn’t-Perform-Network-Access"><a href="#Client-Doesn’t-Perform-Network-Access" class="headerlink" title="Client Doesn’t Perform Network Access"></a>Client Doesn’t Perform Network Access</h3><p>When you wrap behavior that does not perform network access, but where latency is a concern or the threading overhead is unacceptable, you can set the <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommandProperties.html#executionIsolationStrategy\(\" target="_blank" rel="noopener"><code>executionIsolationStrategy</code></a>) property to <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommandProperties.ExecutionIsolationStrategy.html" target="_blank" rel="noopener"><code>ExecutionIsolationStrategy</code></a><code>.SEMAPHORE</code> and Hystrix will use semaphore isolation instead.</p>
<p>The following shows how to set this property as the default for a command via code (you can also override it via dynamic properties at runtime).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandUsingSemaphoreIsolation</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommandUsingSemaphoreIsolation</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"ExampleGroup"</span>))</span><br><span class="line">                <span class="comment">// since we're doing an in-memory cache lookup we choose SEMAPHORE isolation</span></span><br><span class="line">                .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()</span><br><span class="line">                        .withExecutionIsolationStrategy(ExecutionIsolationStrategy.SEMAPHORE)));</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// a real implementation would retrieve data from in memory data structure</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ValueFromHashMap_"</span> + id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="../blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandUsingSemaphoreIsolation.java">View Source</a></p>
<p><a name="Common-Patterns-GetSetGet"></a></p>
<h3 id="Get-Set-Get-with-Request-Cache-Invalidation"><a href="#Get-Set-Get-with-Request-Cache-Invalidation" class="headerlink" title="Get-Set-Get with Request Cache Invalidation"></a>Get-Set-Get with Request Cache Invalidation</h3><p>If you are implementing a Get-Set-Get use case where the Get receives enough traffic that request caching is desired but sometimes a Set occurs on another command that should invalidate the cache within the same request, you can invalidate the cache by calling <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixRequestCache.html#clear\(java.lang.String\" target="_blank" rel="noopener"><code>HystrixRequestCache.clear()</code></a>).</p>
<p>Here is an example implementation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandUsingRequestCacheInvalidation</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* represents a remote data store */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> String prefixStoredOnRemoteDataStore = <span class="string">"ValueBeforeSet_"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GetterCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HystrixCommandKey GETTER_KEY = HystrixCommandKey.Factory.asKey(<span class="string">"GetterCommand"</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">GetterCommand</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"GetSetGet"</span>))</span><br><span class="line">                    .andCommandKey(GETTER_KEY));</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> prefixStoredOnRemoteDataStore + id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">getCacheKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> String.valueOf(id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Allow the cache to be flushed for this object.</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">         *            argument that would normally be passed to the command</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">flushCache</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">            HystrixRequestCache.getInstance(GETTER_KEY,</span><br><span class="line">                    HystrixConcurrencyStrategyDefault.getInstance()).clear(String.valueOf(id));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SetterCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String prefix;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SetterCommand</span><span class="params">(<span class="keyword">int</span> id, String prefix)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(HystrixCommandGroupKey.Factory.asKey(<span class="string">"GetSetGet"</span>));</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">            <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// persist the value against the datastore</span></span><br><span class="line">            prefixStoredOnRemoteDataStore = prefix;</span><br><span class="line">            <span class="comment">// flush the cache</span></span><br><span class="line">            GetterCommand.flushCache(id);</span><br><span class="line">            <span class="comment">// no return value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="../blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandUsingRequestCacheInvalidation.java">View Source</a></p>
<p>The unit test that confirms the behavior is:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getGetSetGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HystrixRequestContext context = HystrixRequestContext.initializeContext();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            assertEquals(<span class="string">"ValueBeforeSet_1"</span>, <span class="keyword">new</span> GetterCommand(<span class="number">1</span>).execute());</span><br><span class="line">            GetterCommand commandAgainstCache = <span class="keyword">new</span> GetterCommand(<span class="number">1</span>);</span><br><span class="line">            assertEquals(<span class="string">"ValueBeforeSet_1"</span>, commandAgainstCache.execute());</span><br><span class="line">            <span class="comment">// confirm it executed against cache the second time</span></span><br><span class="line">            assertTrue(commandAgainstCache.isResponseFromCache());</span><br><span class="line">            <span class="comment">// set the new value</span></span><br><span class="line">            <span class="keyword">new</span> SetterCommand(<span class="number">1</span>, <span class="string">"ValueAfterSet_"</span>).execute();</span><br><span class="line">            <span class="comment">// fetch it again</span></span><br><span class="line">            GetterCommand commandAfterSet = <span class="keyword">new</span> GetterCommand(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">// the getter should return with the new prefix, not the value from cache</span></span><br><span class="line">            assertFalse(commandAfterSet.isResponseFromCache());</span><br><span class="line">            assertEquals(<span class="string">"ValueAfterSet_1"</span>, commandAfterSet.execute());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            context.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="MigratingLibrary"></a></p>
<h2 id="Migrating-a-Library-to-Hystrix"><a href="#Migrating-a-Library-to-Hystrix" class="headerlink" title="Migrating a Library to Hystrix"></a>Migrating a Library to Hystrix</h2><p>When you are migrating an existing client library to use Hystrix, you should replace each of the &ldquo;service methods&rdquo; with a <code>HystrixCommand</code>.</p>
<p>The service methods should then forward calls to the <code>HystrixCommand</code> and not have any additional business logic in them.</p>
<p>Thus, before migration a service library may look like this:</p>
<p>[[images/library-migration-to-hystrix-without-640.png]]</p>
<p>After migrating, users of a library will be able to access the <code>HystrixCommand</code>s directly or indirectly via the service facade that delegates to the <code>HystrixCommand</code>s.</p>
<p>[[images/library-migration-to-hystrix-with-640.png]]</p>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2018/04/17/hystrix/How-To-Use/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2018/04/17/java/thread-interrupt/">thread-interrupt</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2018-04-16T16:00:00.000Z">2018-04-17</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">hello world</a>
                

              </li>
            
            <li>
              <span class="heading-span">With: </span>
              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <p>首先，一个线程不应该由其他线程来强制中断或停止，而是应该由线程自己自行停止。<br>所以，Thread.stop, Thread.suspend, Thread.resume 都已经被废弃了。<br>而 Thread.interrupt 的作用其实也不是中断线程，而是「通知线程应该中断了」，<br>具体到底中断还是继续运行，应该由被通知的线程自己处理。</p>
<p>具体来说，当对一个线程，调用 interrupt() 时，<br>① 如果线程处于被阻塞状态（例如处于sleep, wait, join 等状态），那么线程将立即退出被阻塞状态，并抛出一个InterruptedException异常。仅此而已。<br>② 如果线程处于正常活动状态，那么会将该线程的中断标志设置为 true，仅此而已。被设置中断标志的线程将继续正常运行，不受影响。</p>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2018/04/17/java/thread-interrupt/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2018/04/17/java/gc/">gc</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2018-04-16T16:00:00.000Z">2018-04-17</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">hello world</a>
                

              </li>
            
            <li>
              <span class="heading-span">With: </span>
              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <h4 id="minor-gc"><a href="#minor-gc" class="headerlink" title="minor gc"></a>minor gc</h4><p>minor gc都会stw。</p>
<h4 id="gc-log"><a href="#gc-log" class="headerlink" title="gc log"></a>gc log</h4><p>-XX:+PrintGC</p>
<p>-XX:+PrintGCDetails</p>
<p>-XX:+PrintGCTimeStamps</p>
<p>-Xloggc:/tmp/gc-test.log</p>
<p>-XX:+HeapDumpOnOutOfMemoryError</p>
<p>-XX:+UseGCLogfileRotation -XX:NumberOfGCLogfiles=N -XX:GCLogfileSize=N  日志文件循环</p>
<h2 id="garbage-collector"><a href="#garbage-collector" class="headerlink" title="garbage collector"></a>garbage collector</h2><h3 id="serial"><a href="#serial" class="headerlink" title="serial"></a>serial</h3><p>-XX:+UseSerialGC</p>
<h3 id="throughput"><a href="#throughput" class="headerlink" title="throughput"></a>throughput</h3><p>-XX:+UseParallelGC</p>
<p>-XX:+UseParallelOldGC</p>
<h3 id="cms"><a href="#cms" class="headerlink" title="cms"></a>cms</h3><p>cms默认使用Parnew作为young收集器，cms停顿时间更短，应用线程只在minorGC以及后台线程扫描老年代时发生短暂的停顿。</p>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>更高的CPU使用。</li>
<li>堆容易碎片化。</li>
<li>如果cms后台线程没有足够的cpu资源，或者碎片化过于严重或者处理速度过慢导致无法找到连续空间分配对象（ Concurrent Mode Failure），cms会蜕变为serial收集器的行为：暂停所有线程，使用单线程回收，整理老年代空间。</li>
</ul>
<h4 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h4><ol>
<li><p>初始标记 暂停所有应用线程</p>
<p>89.976: [GC [1 CMS-initial-mark: 702254K(1398144K)]<br>772530K(2027264K), 0.0830120 secs]<br>[Times: user=0.08 sys=0.00, real=0.08 secs]</p>
<p>702254K 老年代中使用大小</p>
<p>1398144K 老年代总大小</p>
<p>772530K 被占用的堆大小</p>
<p>2027264K 堆大小</p>
<p>0.08 secs 暂停时间</p>
</li>
<li><p>并发标记阶段 应用线程不暂停</p>
<p>90.059: [CMS-concurrent-mark-start]<br>90.887: [CMS-concurrent-mark: 0.823/0.828 secs]<br>[Times: user=1.11 sys=0.00, real=0.83 secs]</p>
</li>
<li><p>预清理阶段  应用线程不暂停</p>
<p>90.887: [CMS-concurrent-preclean-start]<br>90.892: [CMS-concurrent-preclean: 0.005/0.005 secs]<br>[Times: user=0.01 sys=0.00, real=0.01 secs]</p>
</li>
<li><p>重新标记阶段  可中断预清理</p>
<p>90.892: [CMS-concurrent-abortable-preclean-start]<br>92.392: [GC 92.393: [ParNew: 629120K-&gt;69888K(629120K), 0.1289040 secs]<br>1331374K-&gt;803967K(2027264K), 0.1290200 secs]<br>[Times: user=0.44 sys=0.01, real=0.12 secs]<br>94.473: [CMS-concurrent-abortable-preclean: 3.451/3.581 secs]<br>[Times: user=5.03 sys=0.03, real=3.58 secs]<br>94.474: [GC[YG occupancy: 466937 K (629120 K)]<br>94.474: [Rescan (parallel) , 0.1850000 secs]<br>94.659: [weak refs processing, 0.0000370 secs]<br>94.659: [scrub string table, 0.0011530 secs]<br>[1 CMS-remark: 734079K(1398144K)]<br>1201017K(2027264K), 0.1863430 secs]<br>[Times: user=0.60 sys=0.01, real=0.18 secs]</p>
</li>
<li><p>清除阶段 并发</p>
<p>94.661: [CMS-concurrent-sweep-start]<br>95.223: [GC 95.223: [ParNew: 629120K-&gt;69888K(629120K), 0.1322530 secs]<br>999428K-&gt;472094K(2027264K), 0.1323690 secs]<br>[Times: user=0.43 sys=0.00, real=0.13 secs]<br>95.474: [CMS-concurrent-sweep: 0.680/0.813 secs]<br>[Times: user=1.45 sys=0.00, real=0.82 secs]</p>
<p>4.5中的Parnew说明新生代和老年代的回收可以并发进行。</p>
</li>
</ol>
<h4 id="cms可能碰到的问题"><a href="#cms可能碰到的问题" class="headerlink" title="cms可能碰到的问题"></a>cms可能碰到的问题</h4><ol>
<li><p>Concurrent mode failure</p>
<p>增加老年代</p>
<p>2) </p>
</li>
<li><p>老年代有足够的空间容纳晋升对象，但由于碎片化严重，导致晋升失败。</p>
<p>cms在新生代收集时，对象晋升失败。然后对整个老年代进行整理压缩。</p>
<p>6043.903: [GC 6043.903:<br>[ParNew (promotion failed): 614254K-&gt;629120K(629120K), 0.1619839 secs]<br>6044.217: [CMS: 1342523K-&gt;1336533K(2027264K), 30.7884210 secs]<br>2004251K-&gt;1336533K(1398144K),<br>[CMS Perm : 57231K-&gt;57231K(95548K)], 28.1361340 secs]<br>[Times: user=28.13 sys=0.38, real=28.13 secs]</p>
</li>
<li><p>​</p>
</li>
</ol>
<h4 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h4><ul>
<li>-XX:+UseParNewGC</li>
<li>-XX:+UseConcMarkSweepGC</li>
<li>-XX:CMSInitiatingOccupancyFraction=N,-XX:+CMSUseInitiatingOccupancyOnly</li>
<li>​</li>
</ul>
<h5 id="g1"><a href="#g1" class="headerlink" title="g1"></a>g1</h5><p>g1将堆划分为若干region（默认2048），仍属于分带收集器。首先收集垃圾最多的分区。新生代的垃圾收集仍然采用暂停所有应用线程<br>的方式，将存活对象移动到老年代或者 Survivor 空间。同其他的收集算法一样，这些操作<br>也利用多线程的方式完成。</p>
<p>缺点：</p>
<ul>
<li>更多的cpu消耗。负责gc的多个thread，必须获得足够的cpu运行周期。</li>
</ul>
<p>过程：</p>
<ol>
<li><p>初始标记阶段 initial-mark 暂停应用线程</p>
<p>50.541: [GC pause (young) (initial-mark), 0.27767100 secs]<br>[Eden: 1220M(1220M)-&gt;0B(1220M)<br>Survivors: 144M-&gt;144M Heap: 3242M(4096M)-&gt;2093M(4096M)]<br>[Times: user=1.02 sys=0.04, real=0.28 secs]</p>
</li>
<li><p>扫描根分区 root region</p>
<p>50.819: [GC concurrent-root-region-scan-start]<br>51.408: [GC concurrent-root-region-scan-end, 0.5890230]</p>
<p>这个阶段中不能发生新生代垃圾收集，因此预留足够的 CPU 周期给<br>后台线程运行是非常重要的。如果扫描根分区时，新生代空间刚巧用尽，新生代垃圾收集<br>（会暂停所有的应用线程）必须等待根扫描结束才能完成。效果上，这意味着新生代垃圾<br>收集的停顿时间会更长（远超过正常的耗时）</p>
<p>350.994: [GC pause (young)<br>351.093: [GC concurrent-root-region-scan-end, 0.6100090]<br>351.093: [GC concurrent-mark-start],<br>0.37559600 secs]</p>
</li>
<li><p>并发标记  并发标记阶段是可以中断的，所以这个阶段中可能发生新生代垃圾收集。紧接在标记阶段之后的是重新标记（ remarking）阶段和正常的清理阶段  暂停应用线程</p>
<p>111.382: [GC concurrent-mark-start]<br>….<br>120.905: [GC concurrent-mark-end, 9.5225160 sec]</p>
<p>​</p>
<p>120.910: [GC remark 120.959:<br>[GC ref-PRC, 0.0000890 secs], 0.0718990 secs]<br>[Times: user=0.23 sys=0.01, real=0.08 secs]<br>120.985: [GC cleanup 3510M-&gt;3434M(4096M), 0.0111040 secs]<br>[Times: user=0.04 sys=0.00, real=0.01 secs]</p>
</li>
<li><p>并发清理</p>
<p>120.996: [GC concurrent-cleanup-start]<br>120.996: [GC concurrent-cleanup-end, 0.0004520]</p>
<p>至此，G1的垃圾定位结束，定位出X region。</p>
</li>
<li><p>mixed gc</p>
<p>79.826: [GC pause (mixed), 0.26161600 secs]<br>….<br>[Eden: 1222M(1222M)-&gt;0B(1220M)<br>Survivors: 142M-&gt;144M Heap: 3200M(4096M)-&gt;1964M(4096M)]<br>[Times: user=1.01 sys=0.00, real=0.26 secs]</p>
</li>
</ol>
<p>-XX:+UseG1GC</p>
<p>#####控制并发</p>
<p>-XX:ParallelGCThreads=N gc线程数，影响以下参数：</p>
<ul>
<li>使用 -XX:+UseParallelGC 收集新生代空间</li>
<li>使用 -XX:+UseParallelOldGC 收集老年代空间</li>
</ul>
<ul>
<li>使用 -XX:+UseParNewGC 收集新生代空间</li>
<li>使用 -XX:+UseG1GC 收集新生代空间</li>
<li>CMS 收集器的stw阶段（但并非 Full GC）</li>
<li>G1 收集器的stw阶段（但并非 Full GC）</li>
</ul>
<p>-XX:+UseComparessedOops</p>
<p>-XX:+PrintTLAB    输出TLAB信息<br>-XX:+UseTLAB    启用TLAB<br>-XX:TLABSize=N    TLAB默认大小<br>-XX:+ResizeTLAB    是否启动动态修改TLAB，每次gc动态修改</p>
<p>-XX:G1HeapRegionSize=N 标志设置（正常情况下，默认值是 0，意味着使用刚才描述的动态算法计算，分区大小 = 1 &lt;&lt; log(初始堆的大小 /2048);,分区的大小最小是 1 MB，最大不能超过 32 MB</p>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2018/04/17/java/gc/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2018/04/17/golang/golang-test/">golang-test</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2018-04-16T16:00:00.000Z">2018-04-17</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">hello world</a>
                

              </li>
            
            <li>
              <span class="heading-span">With: </span>
              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <p>1，测试单个文件，一定要带上被测试的原文件</p>
<pre><code>Go test -v  wechat_test.go wechat.go 
</code></pre><p>2，测试单个方法</p>
<pre><code>go test -v -test.run TestRefreshAccessToken
</code></pre>
          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2018/04/17/golang/golang-test/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2018/04/17/kafka/kafka-reassign-partitions/">kafka-reassign-partitions</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2018-04-16T16:00:00.000Z">2018-04-17</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">hello world</a>
                

              </li>
            
            <li>
              <span class="heading-span">With: </span>
              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <h3 id="topic添加partition"><a href="#topic添加partition" class="headerlink" title="topic添加partition"></a>topic添加partition</h3><ul>
<li>需操作的topic，定义一个json文件</li>
</ul>
<p>➜  bin vi topic.json</p>
<pre><code>{
    &quot;topics&quot;:[{&quot;topics&quot;:&quot;test&quot;}],
    &quot;version&quot;:1
}
</code></pre><ul>
<li>生成reassign计划</li>
</ul>
<p>➜  bin ./kafka-reassign-partitions.sh –zookeeper localhost:2181 –topics-to-move-json-file ./topic.json –broker-list ‘0,1,2’ –generate<br>Current partition replica assignment<br>{“version”:1,”partitions”:[{“topic”:”test”,”partition”:4,”replicas”:[0,2,1]},{“topic”:”test”,”partition”:1,”replicas”:[0,2,1]},{“topic”:”test”,”partition”:2,”replicas”:[1,0,2]},{“topic”:”test”,”partition”:5,”replicas”:[1,0,2]},{“topic”:”test”,”partition”:0,”replicas”:[2,1,0]},{“topic”:”test”,”partition”:3,”replicas”:[2,1,0]}]}</p>
<p>Proposed partition reassignment configuration<br>{“version”:1,”partitions”:[{“topic”:”test”,”partition”:4,”replicas”:[2,1,0]},{“topic”:”test”,”partition”:1,”replicas”:[2,0,1]},{“topic”:”test”,”partition”:5,”replicas”:[0,2,1]},{“topic”:”test”,”partition”:2,”replicas”:[0,1,2]},{“topic”:”test”,”partition”:0,”replicas”:[1,2,0]},{“topic”:”test”,”partition”:3,”replicas”:[1,0,2]}]}</p>
<ul>
<li>保存reassign计划json</li>
</ul>
<p>➜  bin vi reassignment.json</p>
<ul>
<li>执行reassign计划</li>
</ul>
<p>➜  bin ./kafka-reassign-partitions.sh –zookeeper localhost:2181 –reassignment-json-file ./reassignment.json –execute<br>Current partition replica assignment</p>
<p>{“version”:1,”partitions”:[{“topic”:”test”,”partition”:4,”replicas”:[0,2,1]},{“topic”:”test”,”partition”:1,”replicas”:[0,2,1]},{“topic”:”test”,”partition”:2,”replicas”:[1,0,2]},{“topic”:”test”,”partition”:5,”replicas”:[1,0,2]},{“topic”:”test”,”partition”:0,”replicas”:[2,1,0]},{“topic”:”test”,”partition”:3,”replicas”:[2,1,0]}]}</p>
<p>Save this to use as the –reassignment-json-file option during rollback<br>Successfully started reassignment of partitions.</p>
<ul>
<li>校验reassign计划</li>
</ul>
<p>➜  bin ./kafka-reassign-partitions.sh –zookeeper localhost:2181 –reassignment-json-file ./reassignment.json –verify<br>Status of partition reassignment:<br>Reassignment of partition [test,4] completed successfully<br>Reassignment of partition [test,0] completed successfully<br>Reassignment of partition [test,3] completed successfully<br>Reassignment of partition [test,2] completed successfully<br>Reassignment of partition [test,1] completed successfully<br>Reassignment of partition [test,5] completed successfully</p>
<p>增加partition完成，但是老的partition中的数据不会迁移到新的partition</p>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2018/04/17/kafka/kafka-reassign-partitions/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2018/04/17/kafka/kafka-tools/">kafka-tools</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2018-04-16T16:00:00.000Z">2018-04-17</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">hello world</a>
                

              </li>
            
            <li>
              <span class="heading-span">With: </span>
              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <p>./kafka-topics.sh –alter –zookeeper localhost:2181  –topic test2 –partitions 6</p>
<p>./kafka-topics.sh –describe –zookeeper localhost:2181 –topic test2</p>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2018/04/17/kafka/kafka-tools/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2018/04/17/kafka/kafka/">kafka-command</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2018-04-16T16:00:00.000Z">2018-04-17</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">hello world</a>
                

              </li>
            
            <li>
              <span class="heading-span">With: </span>
              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p>####启动</p>
<p>bin/kafka-server-start.sh config/server.propertis &amp;</p>
<p>####创建topic</p>
<p>bin/kafka-topics.sh –create –zookeeper localhost:2181 –replication-factor 3 –partitions 1 –topic my-replicated-topic</p>
<h4 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h4><p>当有节点加入或离开集群时，controller负责在partition和replicas中选举leader。controller使用epoch number来防止脑裂问题（两个节点都认为自己是controller）。</p>
<p>集群中第一个在zk中建立/controller  ephemeral节点的broker会成为controller。其他的broker会watch /controller。</p>
<p>replication</p>
<p>leader replica，follower replica</p>
<p>​                       Fetch Request</p>
<p>Follower Replica +——————————–&gt; Leader Replica</p>
<p>Fetch Request包含要接收的下一个消息的offset，一直是有序的。</p>
<p>如果follower 十秒钟(replica.lag.time.max.ms控制)没有请求消息，或者在十秒钟内数据没有跟上leader，这个节点被认为out of sync。如果一个replica无法跟上leader，在leader异常时，该replica不能成为新的leader。</p>
<p>send acknowledge</p>
<p>acks=0 means that a message is considered to be written successfully to Kafka if<br>the producer managed to send it over the network</p>
<p>acks=1 means that the leader will send either an acknowledgment or an error the<br>moment it got the message and wrote it to the partition data file (but not neces‐<br>sarily synced to disk)</p>
<p>acks=all means that the leader will wait until all in-sync replicas got the message<br>before sending back an acknowledgment or an error</p>
<p>ISR：In-Sync Replicas</p>
<p>Exactly-once delivery</p>
<ul>
<li>writing results to a system that has some support for unique keys</li>
<li>The idea is to write the records and their offsets in the same transaction so they will be in-sync.When starting up, retrieve the offsets of the latest records written to the external store and then use consumer.seek() to start consuming again from those offsets. </li>
</ul>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2018/04/17/kafka/kafka/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2018/04/17/总结/总结/">总结</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2018-04-16T16:00:00.000Z">2018-04-17</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">hello world</a>
                

              </li>
            
            <li>
              <span class="heading-span">With: </span>
              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <ul>
<li>状态机反思<ol>
<li>任意状态可重入</li>
<li>状态机包含业务状态和处理状态，处理状态用于防止并发问题</li>
</ol>
</li>
<li>慢sql优化<ol>
<li>explain确认索引，函数，join是否合理等</li>
<li>接口设计是否合理，可否一个复杂接口改成多个来实现</li>
<li>业务设计是否合理，是否有必要展示所有数据</li>
<li>存储是否合理，是否可以使用数据仓库，大数据等方法解决</li>
</ol>
</li>
</ul>
<ul>
<li><p>php连接数据库失败，无任何异常，多个库</p>
<p>方法：抓包，看请求失败情况</p>
</li>
<li><p>客户端连接zookeeper，经常断掉</p>
<p>方法：加大sessionTimeout</p>
</li>
<li><p>页面，刷出信息后，直接跳转到登录页面</p>
<p>方法：抓包，抓出页面信息，发现页面中有一段跳转代码</p>
</li>
<li><p>tomcat自动挂掉</p>
<p>方法：查看系统日志，发现被系统kill，加大系统内存​</p>
</li>
</ul>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2018/04/17/总结/总结/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2018/04/17/spring/spring 自定义注解/">自定义注解</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2018-04-16T16:00:00.000Z">2018-04-17</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">hello world</a>
                

              </li>
            
            <li>
              <span class="heading-span">With: </span>
              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <h1 id="spring-自定义注解"><a href="#spring-自定义注解" class="headerlink" title="spring 自定义注解"></a>spring 自定义注解</h1><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>LogConfiguration.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class LogConfiguration extends AbstractPointcutAdvisor implements IntroductionAdvisor,BeanFactoryAware&#123;</span><br><span class="line">    private Advice advice;</span><br><span class="line">    private Pointcut pointcut;</span><br><span class="line">    private BeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init()&#123;</span><br><span class="line">        Set&lt;Class&lt;? extends Annotation&gt;&gt; annotationTypes=new LinkedHashSet&lt;&gt;(1);</span><br><span class="line">        annotationTypes.add(Log.class);</span><br><span class="line">        this.pointcut=buildPointcut(annotationTypes);</span><br><span class="line">        this.advice=buildAdvice();</span><br><span class="line">        if(this.advice instanceof BeanFactoryAware)&#123;</span><br><span class="line">            ((BeanFactoryAware)this.advice).setBeanFactory(beanFactory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected Advice buildAdvice() &#123;</span><br><span class="line">        LogInterceptor interceptor = new LogInterceptor();</span><br><span class="line">        return interceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected Pointcut buildPointcut(Set&lt;Class&lt;? extends Annotation&gt;&gt; retryAnnotationTypes) &#123;</span><br><span class="line">        ComposablePointcut result = null;</span><br><span class="line">        for (Class&lt;? extends Annotation&gt; retryAnnotationType : retryAnnotationTypes) &#123;</span><br><span class="line">            Pointcut filter = new AnnotationClassOrMethodPointcut(retryAnnotationType);</span><br><span class="line">            if (result == null) &#123;</span><br><span class="line">                result = new ComposablePointcut(filter);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                result.union(filter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private final class AnnotationClassOrMethodPointcut extends StaticMethodMatcherPointcut &#123;</span><br><span class="line"></span><br><span class="line">        private final MethodMatcher methodResolver;</span><br><span class="line"></span><br><span class="line">        AnnotationClassOrMethodPointcut(Class&lt;? extends Annotation&gt; annotationType) &#123;</span><br><span class="line">            this.methodResolver = new AnnotationMethodMatcher(annotationType);</span><br><span class="line">            setClassFilter(new AnnotationClassOrMethodFilter(annotationType));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public boolean matches(Method method, Class&lt;?&gt; targetClass) &#123;</span><br><span class="line">            return getClassFilter().matches(targetClass) || this.methodResolver.matches(method, targetClass);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private final class AnnotationClassOrMethodFilter extends AnnotationClassFilter &#123;</span><br><span class="line"></span><br><span class="line">        private final AnnotationMethodsResolver methodResolver;</span><br><span class="line"></span><br><span class="line">        AnnotationClassOrMethodFilter(Class&lt;? extends Annotation&gt; annotationType) &#123;</span><br><span class="line">            super(annotationType, true);</span><br><span class="line">            this.methodResolver = new AnnotationMethodsResolver(annotationType);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public boolean matches(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">            return super.matches(clazz) || this.methodResolver.hasAnnotatedMethods(clazz);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class AnnotationMethodsResolver &#123;</span><br><span class="line"></span><br><span class="line">        private Class&lt;? extends Annotation&gt; annotationType;</span><br><span class="line"></span><br><span class="line">        public AnnotationMethodsResolver(Class&lt;? extends Annotation&gt; annotationType) &#123;</span><br><span class="line">            this.annotationType = annotationType;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public boolean hasAnnotatedMethods(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">            final AtomicBoolean found = new AtomicBoolean(false);</span><br><span class="line">            ReflectionUtils.doWithMethods(clazz,</span><br><span class="line">                    new ReflectionUtils.MethodCallback() &#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        public void doWith(Method method) throws IllegalArgumentException,</span><br><span class="line">                                IllegalAccessException &#123;</span><br><span class="line">                            if (found.get()) &#123;</span><br><span class="line">                                return;</span><br><span class="line">                            &#125;</span><br><span class="line">                            Annotation annotation = AnnotationUtils.findAnnotation(method,</span><br><span class="line">                                    annotationType);</span><br><span class="line">                            if (annotation != null) &#123; found.set(true); &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            return found.get();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ClassFilter getClassFilter() &#123;</span><br><span class="line">        return pointcut.getClassFilter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void validateInterfaces() throws IllegalArgumentException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Advice getAdvice() &#123;</span><br><span class="line">        return advice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Class&lt;?&gt;[] getInterfaces() &#123;</span><br><span class="line">        return new Class&lt;?&gt;[]&#123;Log.class&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Pointcut getPointcut() &#123;</span><br><span class="line">        return pointcut;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setBeanFactory(BeanFactory beanFactory) throws BeansException &#123;</span><br><span class="line">        this.beanFactory=beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Log.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Target(&#123;ElementType.METHOD,ElementType.TYPE&#125;)</span><br><span class="line">@Documented</span><br><span class="line">public @interface Log &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LogInterceptor.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class LogInterceptor implements IntroductionInterceptor,BeanFactoryAware&#123;</span><br><span class="line">    private  BeanFactory beanFactory;</span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(MethodInvocation invocation) throws Throwable &#123;</span><br><span class="line">        Method method=invocation.getMethod();</span><br><span class="line">        Log log = AnnotationUtils.findAnnotation(method, Log.class);</span><br><span class="line">        if (log == null) &#123;</span><br><span class="line">            log = AnnotationUtils.findAnnotation(method.getDeclaringClass(), Log.class);</span><br><span class="line">        &#125;</span><br><span class="line">        if (log == null) &#123;</span><br><span class="line">            log = findAnnotationOnTarget(invocation.getThis(), method);</span><br><span class="line">        &#125;</span><br><span class="line">        if(log!=null) &#123;</span><br><span class="line">            System.out.println(&quot;invoke:&quot; + invocation.getMethod().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        return invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Log findAnnotationOnTarget(Object target, Method method) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Method targetMethod = target.getClass().getMethod(method.getName(), method.getParameterTypes());</span><br><span class="line">            return AnnotationUtils.findAnnotation(targetMethod, Log.class);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception e) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean implementsInterface(Class&lt;?&gt; intf) &#123;</span><br><span class="line">        return Log.class.isAssignableFrom(intf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setBeanFactory(BeanFactory beanFactory) throws BeansException &#123;</span><br><span class="line">        this.beanFactory=beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2018/04/17/spring/spring 自定义注解/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2018/04/17/git/git/">git command</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2018-04-16T16:00:00.000Z">2018-04-17</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">hello world</a>
                

              </li>
            
            <li>
              <span class="heading-span">With: </span>
              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <p>Git常用命令</p>
<p>git init 将当前目录初始化为git目录，当前目录会出现一个.git目录</p>
<p>git add *.c                将c结尾的文件加入版本控制</p>
<p>git add 目录 将目录下所有文件加入版本控制</p>
<p>git commit –m ‘注释’ 将版本控制的文件提交到本地仓库 –m加注释</p>
<p>git commit –a –m ‘注释’ 修改的内容不用再次加入暂存区（git add）,此命令会把所有跟踪的文件暂存起来并一起提交</p>
<p>git clone ‘git://github.com//….git’ 从远程仓库clone到本地</p>
<p>git status 查看文件状态，如果出现修改的，未跟踪或删除的文件会显示出来</p>
<p>git add file/dir 将修改的文件加入暂存，加入暂存后如果又对其进行修改，则需要重新添加文件到暂存</p>
<p>.gitignore 忽略某些文件，编辑此文件即可</p>
<p>*.a                              #忽略所有.a结尾的文件</p>
<p>!lib.a        #lib.a除外</p>
<p>/TODO    #仅忽略根目录下的TODO文件</p>
<p>build/       #忽略build目录下的所有文件</p>
<p>doc/*.txt                  #会忽略doc/notes.txt，但不包括doc/server/arch.txt</p>
<p>git diff 查看尚未暂存的文件更新了哪些部分</p>
<p>git diff –cached 查看已经暂存的文件和上次提交时的快照之间的差异</p>
<p>git diff –staged 同上</p>
<p>rm file 删除本地，</p>
<p>git rm file 使git记录此次移除文件的操作</p>
<p>git rm –cached file 从git暂存区中删除，但仍保留在本地目录、</p>
<p>git rm *~ 递归删除当前目录机器</p>
<p>git mv file_from file_to git移动文件</p>
<p>git log 查看提交历史</p>
<p>​                  -p 展开显示每次提交的内容差异</p>
<p>​                  -n 仅显示最近的几次更新</p>
<p>​                  –stat仅显示简要的增改行数统计</p>
<p>git commit –amend 撤销刚才的提交操作，并用当前的暂存区域快照提交。</p>
<p>git reset file 取消暂存区域中的文件</p>
<p>git checkout – file 取消修改，回到之前的版本。 </p>
<p>Git保存用户名密码：</p>
<p>编辑.git/config文件，添加块</p>
<p>[credential]</p>
<p>​                  helper=store</p>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2018/04/17/git/git/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>





<nav id="pagination">
  
    <a href="/" class="alignleft prev">Prev</a>
  
  
    <a href="/page/3/" class="alignright next">Next</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright"><div class="padding">
	
	  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:unei.me">
  </form>
</div>
	
	  
<div class="widget recent-post">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/2018/05/10/os/内存/">内存</a>
      </li>
    
      <li>
        <a href="/2018/05/04/java/ParallelScavenge和ParNew/"></a>
      </li>
    
      <li>
        <a href="/2018/05/03/java/gc基础/"></a>
      </li>
    
      <li>
        <a href="/2018/04/26/java/tomcat异常分析/">tomcat异常分析</a>
      </li>
    
      <li>
        <a href="/2018/04/17/zookeeper/zookeeper/">zookeeper注意点</a>
      </li>
    
  </ul>
</div>

	
	  
<div class="widget category">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/books/">books</a><small>1</small></li>
  
    <li><a href="/categories/git/">git</a><small>1</small></li>
  
    <li><a href="/categories/golang/">golang</a><small>4</small></li>
  
    <li><a href="/categories/hystrix/">hystrix</a><small>2</small></li>
  
    <li><a href="/categories/java/">java</a><small>6</small></li>
  
    <li><a href="/categories/kafka/">kafka</a><small>3</small></li>
  
    <li><a href="/categories/linux/">linux</a><small>3</small></li>
  
    <li><a href="/categories/mysql/">mysql</a><small>1</small></li>
  
    <li><a href="/categories/network/">network</a><small>7</small></li>
  
    <li><a href="/categories/os/">os</a><small>1</small></li>
  
    <li><a href="/categories/redis/">redis</a><small>1</small></li>
  
    <li><a href="/categories/ruby/">ruby</a><small>2</small></li>
  
    <li><a href="/categories/spring/">spring</a><small>3</small></li>
  
    <li><a href="/categories/zookeeper/">zookeeper</a><small>1</small></li>
  
    <li><a href="/categories/总结/">总结</a><small>1</small></li>
  
  </ul>
</div>

	
	  
	
</div></aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="padding">
	<div class="alignleft">
	  
	  &copy; 2018 hello world
	  
	  Powerd by <a href="http://hexo.io/" target="_blank">hexo</a>
	  and Theme by <a href="https://github.com/halfer53/metro-light" target="_blank">metro-light</a>
	</div>

	<div class="alignright">
		
		
		
		
		
		
		
	</div>

	<div class="clearfix"></div>
</div>

<div class="scroll-top"><i class="fa fa-arrow-circle-up"></i></div></footer>
  


<link href='http://apps.bdimg.com/libs/fontawesome/4.1.0/css/font-awesome.css' rel='stylesheet' type='text/css'>
<script src="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>



<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/3.0.4/jquery.imagesloaded.js"></script> -->
<!-- <script src="/js/gallery.js"></script> -->



<script type="text/javascript">
$(window).scroll(function() {

    if($(this).scrollTop() > 400) {
        $('.scroll-top').fadeIn(200);
    } else {
        $('.scroll-top').fadeOut(200);
    }
});

$('.scroll-top').bind('click', function(e) {
    e.preventDefault();
    $('body,html').animate({scrollTop:0},200);
});
</script>


</body>
</html>
